{% extends "admin/page.html" %}

{% block head %}
<title>Abacus - Edit Problem</title>
{% endblock %}

{% block content %}

<form class="ui form" action="/api/problems/{{ problem.id }}" method="PUT" onsuccess="success" async>
  <input name="problem-id" style="display:none" value="{{ problem.problem_id }}">

  <div class="edit-problem-header">
    <h1>Edit Problem {{ problem.id }}</h1>
    <div class="ui negative icon button" onclick="deleteProblem()"><i class="trash icon"></i></div>
    <button type="submit" value="Save" class="ui primary icon button"><i class="icon save"></i></button>
    <span style="display: inline-block"><i>problem_id: {{ problem.problem_id }}</i></span>
  </div>

  <!-- TAB BAR FOR PROBLEM PAGES -->
  <div class="ui top attached tabular menu">
    <div class="active item" tabindex="1">Problem Info</div>
    <div class="item" tabindex="2">Test Data</div>
    <div class="item" tabindex="3">Description</div>
    <div class="item" tabindex="4">Sample Files</div>
  </div>
  <!------------------------------->
  <br>

  <!-- PROBLEM INFO -->
  <section tabindex="1">
    <div class="field">
      <label>Problem ID</label>
      <input name="id" value="{{ problem.id }}">
    </div>

    <div class="field">
      <label>Problem Name</label>
      <input name="problem-name" value="{{ problem.problem_name }}">
    </div>

    <div class="two fields">
      <div class="field">
        <label>Memory Limit</label>
        <input name="memory-limit" value="{{ problem.memory_limit }}">
      </div>
      <div class="field">
        <label>CPU Time Limit</label>
        <input name="cpu-time-limit" value="{{ problem.cpu_time_limit }}">
      </div>
    </div>
  </section>

  <!-- TEST DATA -->
  <section tabindex="2">
    <div class="field">
      <label>Tests</label>
      <div class="ui top attached tabular menu" id="tests">
        {% for test in problem.tests %}
        <div class="item" onclick="makeActive(this)">{{ loop.index }}</div>
        {% endfor %}
        <div class="item" onclick="newTest(this)">+</div>
      </div>
      <div class="ui bottom attached active tab segment" id="tests_content">
        {% for test in problem.tests %}
        <div class="two fields" style="display: none">
          <div class="field">
            <label>Input</label>
            <textarea name="{{ loop.index }}-in">{{ test.in }}</textarea>
          </div>
          <div class="field">
            <label>Answer</label>
            <textarea name="{{ loop.index }}-out">{{ test.out }}</textarea>
          </div>
        </div>
        {% endfor %}
        <div class="field">
          <div class="ui button negative" onclick="deleteActive(this)">Delete</div>
        </div>
      </div>
    </div>
  </section>

  <!-- DESCRIPTION -->
  <section tabindex="3">
    <div class="two fields">
      <div class="field">
        <label>Problem Description</label>
        <textarea name="description" rows id="input_desc">{{ problem.description }}</textarea>
      </div>
      <div class="field">
        <label>Preview</label>
        <div id="preview" class="markdown">{{ problem.description }}</div>
      </div>
    </div>
  </section>

  <!-- SAMPLE FILES -->
  <section tabindex="4">
    <h3>Sample Files</h3>
  </section>
</form>
{% endblock %}

{% block style %}
<style>
  .edit-problem-header {
    display: grid;
    grid-template: "h1 delete save" 30px
                   "id" 1fr;
  }
</style>
{% endblock %}

{% block script %}
<script>
  let converter, textarea, preview;

  function refreshPreview() {
    let md = textarea.value;
    md = md.replaceAll("&gt;", ">");
    md = md.replaceAll("&lt;", "<");
    preview.innerHTML = converter.makeHtml(md);
  }

  function adjustHeight() {
    textarea.style.height = '5px'
    textarea.style.height = (textarea.scrollHeight + 15) + 'px'
  }

  function newTest(elem) {
    const tests = document.querySelector('#tests')
    let n = tests.children.length
    const newItem = createElement(`<div class="item" onclick=makeActive(this)>${n}</div>`)
    tests.insertBefore(newItem, elem)

    const tests_content = document.querySelector('#tests_content')
    tests_content.insertBefore(createElement('<div class="two fields" style="display: none">' +
      '<div class="field">' +
      '<label>Input</label>' +
      `<textarea name="${n}-in">TEST_IN</textarea>` +
      '</div>' +
      '<div class="field">' +
      '<label>Answer</label>' +
      `<textarea name="${n}-out">TEST_OUT</textarea>` +
      '</div>' +
      '</div>'), document.querySelector('#tests_content .ui.button').parentNode)

    makeActive(newItem)
  }

  function deleteProblem() {
    const form = document.querySelector('.ui.form')
    form.setAttribute('method', "DELETE")
    document.querySelector('.ui.form input[type="submit"]').click()
    setTimeout(() => {
      window.location.href = '/admin/problems'
    }, 500)
  }

  function deleteActive(elem) {
    let active_n = document.querySelector('.item.active').innerText
    const item = document.querySelector(`#tests .item:nth-child(${active_n})`)

    document.querySelector(`#tests_content .two.fields:nth-child(${active_n})`).remove()

    if (item.classList.contains('active')) {
      $('#tests .item:first-child').click()
    }

    item.remove()
  }

  function makeActive(elem) {
    // Remove all active classes
    document.querySelector('#tests .active')?.classList.remove('active')
    // Make this element active
    elem.classList.add('active')

    // Hide all test textareas
    document.querySelectorAll('#tests_content .fields').forEach(e => e.style.display = 'none')
    // Make this test's textarea visible
    $(`#tests_content .two.fields`)[parseInt(elem.innerText) - 1].style.display = 'flex'
  }

  document.addEventListener('DOMContentLoaded', () => {
    converter = new showdown.Converter();
    textarea = document.querySelector('#input_desc')
    preview = document.querySelector('#preview')

    textarea.addEventListener('keyup', () => {
      refreshPreview()
      adjustHeight()
    })

    $(document).on('click', '.item[tabindex]', function (e) {
      $('.item[tabindex].active').removeClass('active')
      $(this).addClass('active')

      $('section[tabindex]').css('display', 'none')
      const tabindex = $(this).attr('tabindex')
      $(`section[tabindex=${tabindex}]`).css('display', 'block')
    })

    adjustHeight()
    $('#tests .item:first-child').click()
    $('.item[tabindex]:first-child').click()
  })

  function success() {
    notify('Success!', "Your changes have successfully been saved.")
  }
</script>
{% endblock %}