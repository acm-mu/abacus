{% extends 'gold/page.html' %}

{% block head %}
<title>Gold - Submit Problem</title>
{% endblock %}

{% block content %}
{% if not getuserinfo('scratch_username') %}
<div class="xs-12 block">
  You need to attach your scratch account!
</div>
{% else %}
<div class="xs-12 block">
  <form class="ui form" method="POST" action="/api/submissions" enctype="multipart/form-data" callback="submissionSuccess" async>
    <input name="language" value="scratch" style="display: none">
    <input style='display: none' id="scratch_username" value="{{ getuserinfo('scratch_username') }}">
    
    <div class="three fields">
      <div class="field">
        <label>Problem</label>
        <select name='problem-id'>
          {% for problem in problems %}
            <option value="{{ problem['problem_id'] }}">{{ problem['problem_name'] }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label>Scratch URL</label>
        <input type="text" name='scratch_url'
          placeholder="https://scratch.mit.edu/projects/<project_id>"
          value="https://scratch.mit.edu/projects/{{ project_id }}">
      </div>
      <div class="field">
        <label>&NonBreakingSpace;</label>
        <input id="submit_problem" type="submit" class="ui blue button" value="Submit" disabled>
      </div>
    </div>
  </form>
</div>

<div class="xs-12 block" id='scratch_info'>
  <h1>Project Title: <i>"%title%"</i></h1>
  <div class="ui label">
    Project Id <div class="detail">#%id%</div>
  </div>
  <div class="ui label">
    Created <div class="detail">%created_date%</div>
  </div>
  <div class="ui label">
    Modified <div class="detail">%modified_date%</div>
  </div>
  <br /> <br />
  <div class="ui label %public%">
    Public
  </div>
  <div class="ui label %is_published%">
    Published
  </div>
  <a class="ui label" target='_blank' href='https://scratch.mit.edu/projects/%id%'><i class="linkify icon"></i> Link to
    Project</a>
  <p>%description%</p>

  <iframe id='scratch_embedded' src="https://scratch.mit.edu/projects/%id%/embed" allowtransparency="true" width="603"
      height="500" frameborder="0" scrolling="no" allowfullscreen></iframe>

</div>

<div class="xs-12 block" id="share-warning" style="display: none">
  <center>
    <h2>⚠️ Cannot access project! ⚠️</h2>
  </center>
  <br />
  <p>Please make sure you are sharing your project on scratch in order for the judges to view and assess</p>
  <h3>Need help?</h3>
  <a href='/help/scratch_share'>Sharing Projects on Scratch</a>
</div>
{% endif %}
{% endblock %}

{% block style %}
<style>
  img#scratch_image {
    box-shadow: 0px 2px 4px #ccc;
  }
</style>
{% endblock %}

{% block script %}
<script>
  function submissionSuccess(res) {
    window.location.href = `/gold/submissions/${res.submission_id}`
  }

  function fillData(res) {
    const scratchInfo = document.querySelector('#scratch_info')

    shareWarning = document.querySelector('#share-warning')

    document.querySelector('#submit_problem').disabled = res.code == "NotFound"

    if (res.code == "NotFound") {
      scratchInfo.style.display = 'none'
      shareWarning.style.display = 'block'
      return;
    }

    shareWarning.style.display = 'none'
    scratchInfo.style.display = 'block'
    let html = scratchInfo.innerHTML

    html = html.replaceAll('%id%', res.id)
    html = html.replaceAll('%project_img%', res.images['135x102'])
    html = html.replaceAll('%title%', res.title)
    html = html.replaceAll('%description%', res.description)
    html = html.replaceAll('%created_date%', moment(res.history.created).calendar())
    html = html.replaceAll('%modified_date%', moment(res.history.modified).calendar())
    html = html.replaceAll('%is_published%', res.is_published ? 'green' : 'red')
    html = html.replaceAll('%public%', res.public ? 'green' : 'red')

    scratchInfo.innerHTML = html
  }

  document.addEventListener('DOMContentLoaded', function () {
    const scratchInput = document.querySelector('input[name="scratch_url"]')
    const scratchUsername = document.querySelector('#scratch_username').value

    let cachedInput = '';

    setInterval(function () {
      const scratch_url = scratchInput.value;

      if (cachedInput == scratch_url) return
      document.querySelector('#submit_problem').disabled = true
      cachedInput = scratch_url

      try {
        const project_id = scratchInput.value.match(/https:\/\/scratch\.mit\.edu\/projects\/(\d*)/)[1]
        console.log(`https://api.scratch.mit.edu/users/${scratchUsername}/projects/${project_id}`);
        fetch(`https://api.scratch.mit.edu/users/${scratchUsername}/projects/${project_id}`)
          .then(res => res.json())
          .then(res => fillData(res))
        } catch {}
      }, 1000);
  });
</script>
{% endblock %}